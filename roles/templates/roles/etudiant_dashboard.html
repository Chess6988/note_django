{% extends 'base.html' %}
{% block title %}Etudiant Dashboard{% endblock %}

{% block content %}
<!-- Include Bootstrap Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .dashboard-container {
        animation: fadeInUp 0.8s ease-out;
        margin-top: 50px;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .profile-card {
        border-radius: 1rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        background-color: #ffffff;
        padding: 2rem;
    }
    .alert {
        margin-top: 1rem;
    }
    /* Enhanced UI Styles for Modal */
    .modal-content {
        border-radius: 1rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .modal-header {
        border-bottom: none;
    }
    .modal-title {
        font-weight: bold;
    }
    .modal-body {
        padding: 2rem;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-group label {
        font-weight: 500;
        color: #495057;
    }
    .form-select {
        border-radius: 0.5rem;
        border: 1px solid #ced4da;
        padding: 0.75rem;
    }
    .btn-primary {
        background-color: #007bff;
        border: none;
        border-radius: 0.5rem;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
    .btn-secondary {
        background-color: #6c757d;
        border: none;
        border-radius: 0.5rem;
    }
    .btn-secondary:hover {
        background-color: #5a6268;
    }
    ol {
        padding-left: 1.5rem;
    }
    li {
        margin-bottom: 0.5rem;
    }
    /* Progress Bar Styles */
    .progress-container {
        margin-bottom: 2rem;
        position: relative;
    }
    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }
    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }
    .step-label {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
    }
    .progress-step.active .step-number {
        background-color: #007bff;
        color: #fff;
    }
    .progress-step.completed .step-number {
        background-color: #28a745;
        color: #fff;
    }
    .progress-step.active .step-label {
        color: #007bff;
        font-weight: bold;
    }
    .progress-step.completed .step-label {
        color: #28a745;
    }
    /* Lines connecting the steps */
    .progress-step:not(:last-child):after {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        width: 100%;
        height: 2px;
        background-color: #e9ecef;
        z-index: -1;
    }
    .progress-step.completed:not(:last-child):after {
        background-color: #28a745;
    }
    /* Step Container */
    .step {
        display: none;
    }
    .step.active {
        display: block;
    }
    .step-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
    }
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .step-label {
            font-size: 0.8rem;
        }
        .step-number {
            width: 25px;
            height: 25px;
            font-size: 0.8rem;
        }
    }
</style>

<div class="container dashboard-container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card profile-card">
                <div class="card-body text-center">
                    <h3 class="card-title">Welcome, {{ user.first_name }}!</h3>
                    <p class="card-text text-muted">Your account setup is not yet completed.</p>

                    <!-- Profile Information -->
                    <div class="my-4">
                        <p><strong>Email:</strong> {{ user.email }}</p>
                        <p><strong>Username:</strong> {{ user.username }}</p>
                    </div>

                    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createProfileModal">
                        Formulaire de creation de profile
                    </button>

                    <form method="post" action="{% url 'roles:logout' %}" style="display: inline-block;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger d-flex align-items-center justify-content-center gap-2" title="Click to logout">
                            <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_lk80fpsm.json" background="transparent" speed="1" style="width: 30px; height: 30px;" loop autoplay></lottie-player>
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Profile Creation -->
<div class="modal fade" id="createProfileModal" tabindex="-1" aria-labelledby="createProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProfileModalLabel">Create Your Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Progress Steps -->
                <div class="progress-container">
                    <div class="progress-steps">
                        <div class="progress-step active" data-step="1">
                            <span class="step-number">1</span>
                            <span class="step-label">Year & Level</span>
                        </div>
                        <div class="progress-step" data-step="2">
                            <span class="step-number">2</span>
                            <span class="step-label">Field & Semester</span>
                        </div>
                        <div class="progress-step" data-step="3">
                            <span class="step-number">3</span>
                            <span class="step-label">Subjects</span>
                        </div>
                    </div>
                </div>

                {% if matiere_unavailable_message %}
                    <div class="alert alert-info">{{ matiere_unavailable_message }}</div>
                {% endif %}                <form method="post" action="{% url 'roles:etudiant_dashboard' %}" id="profileForm">
                    {% csrf_token %}
                    <input type="hidden" name="form-TOTAL_FORMS" value="1">
                    <input type="hidden" name="form-INITIAL_FORMS" value="0">
                    <input type="hidden" name="form-MIN_NUM_FORMS" value="0">
                    <input type="hidden" name="form-MAX_NUM_FORMS" value="1000">
                    <input type="hidden" name="form-0-annee" id="hidden_annee">
                    <input type="hidden" name="form-0-niveau" id="hidden_niveau">
                    <input type="hidden" name="form-0-filiere" id="hidden_filiere">
                    <input type="hidden" name="form-0-semestre" id="hidden_semestre">
                    <input type="hidden" name="form-0-matiere" id="hidden_matiere">
                    <input type="hidden" name="form-0-matiere_commune" id="hidden_matiere_commune">

                    <!-- Step 1: Academic Year & Level -->
                    <div class="step active" id="step1">
                        <div class="form-group">
                            <label for="id_annee"><i class="bi bi-calendar me-2"></i>Academic Year:</label>
                            <select id="id_annee" name="annee" class="form-select">
                                <option value="">Select Academic Year</option>
                                {% for annee in annee_choices %}
                                    <option value="{{ annee.id }}">{{ annee }}</option>
                                {% endfor %}
                            </select>
                            {{ form.annee.errors }}
                        </div>
                        <div class="form-group">
                            <label for="id_niveau"><i class="bi bi-mortarboard me-2"></i>Level:</label>
                            <select id="id_niveau" name="niveau" class="form-select">
                                <option value="">Select Level</option>
                                {% for niveau in niveau_choices %}
                                    <option value="{{ niveau.id }}">{{ niveau }}</option>
                                {% endfor %}
                            </select>
                            {{ form.niveau.errors }}
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-primary next-step" data-next="2">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Field of Study & Semester -->
                    <div class="step" id="step2">
                        <div class="form-group">
                            <label for="id_filiere"><i class="bi bi-briefcase me-2"></i>Field of Study:</label>
                            <select id="id_filiere" name="filiere" class="form-select">
                                <option value="">Select Field of Study</option>
                                {% for filiere in filiere_choices %}
                                    <option value="{{ filiere.id }}">{{ filiere }}</option>
                                {% endfor %}
                            </select>
                            {{ form.filiere.errors }}
                        </div>
                        <div class="form-group">
                            <label for="id_semestre"><i class="bi bi-clock me-2"></i>Semester:</label>
                            <select id="id_semestre" name="semestre" class="form-select">
                                <option value="">Select Semester</option>
                                {% for semestre in semestre_choices %}
                                    <option value="{{ semestre.id }}">{{ semestre }}</option>
                                {% endfor %}
                            </select>
                            {{ form.semestre.errors }}
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="1">Previous</button>
                            <button type="button" class="btn btn-primary next-step" data-next="3">Next</button>
                        </div>
                    </div>

                    <!-- Step 3: Subjects -->
                    <div class="step" id="step3">
                        <button type="button" id="generateButton" class="btn btn-secondary mb-3" disabled><i class="bi bi-arrow-clockwise me-2"></i>Generate Subjects</button>
                        <div class="form-group">
                            <label for="id_matiere"><i class="bi bi-book me-2"></i>Subject:</label>
                            <select id="id_matiere" name="matiere" class="form-select" disabled>
                                <option value="">Select Subject</option>
                            </select>
                            {{ form.matiere.errors }}
                        </div>
                        <div class="form-group">
                            <label for="id_matiere_commune"><i class="bi bi-collection me-2"></i>Common Subject (Optional):</label>
                            <select id="id_matiere_commune" name="matiere_commune" class="form-select" disabled>
                                <option value="">Select Common Subject</option>
                            </select>
                            {{ form.matiere_commune.errors }}
                        </div>
                        <div class="step-actions">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="2">Previous</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-person-plus me-2"></i>Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{{ matiere_data|json_script:"matiere-data" }}
{{ matiere_commune_data|json_script:"matiere-commune-data" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Script loaded');

        // Parse JSON data from the template
        let matiereData, matiereCommuneData;
        try {
            matiereData = JSON.parse(document.getElementById('matiere-data').textContent);
            matiereCommuneData = JSON.parse(document.getElementById('matiere-commune-data').textContent);
            console.log('Initial matiereData:', matiereData);
            console.log('Initial matiereCommuneData:', matiereCommuneData);
        } catch (e) {
            console.error('Error parsing JSON data:', e);
            return;
        }

        // Get references to elements
        const filiereSelect = document.getElementById('id_filiere');
        const semestreSelect = document.getElementById('id_semestre');
        const niveauSelect = document.getElementById('id_niveau');
        const anneeSelect = document.getElementById('id_annee');
        const matiereSelect = document.getElementById('id_matiere');
        const matiereCommuneSelect = document.getElementById('id_matiere_commune');
        const generateButton = document.getElementById('generateButton');
        const form = document.getElementById('profileForm');
        const progressSteps = document.querySelectorAll('.progress-step');
        const steps = document.querySelectorAll('.step');
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');

        // Multi-step form logic
        let currentStep = 1;        function updateHiddenFields() {
            document.getElementById('hidden_annee').value = anneeSelect.value;
            document.getElementById('hidden_niveau').value = niveauSelect.value;
            document.getElementById('hidden_filiere').value = filiereSelect.value;
            document.getElementById('hidden_semestre').value = semestreSelect.value;
            document.getElementById('hidden_matiere').value = matiereSelect.value;
            document.getElementById('hidden_matiere_commune').value = matiereCommuneSelect.value;
            // Set management form fields
            document.getElementsByName('form-TOTAL_FORMS')[0].value = '1';
            document.getElementsByName('form-INITIAL_FORMS')[0].value = '0';
            document.getElementsByName('form-MIN_NUM_FORMS')[0].value = '0';
            document.getElementsByName('form-MAX_NUM_FORMS')[0].value = '1000';
        }

        function updateStep(stepNumber) {
            // Update step visibility
            steps.forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNumber}`).classList.add('active');

            // Update progress steps
            progressSteps.forEach(step => {
                step.classList.remove('active', 'completed');
                const stepNum = parseInt(step.dataset.step);
                if (stepNum < stepNumber) {
                    step.classList.add('completed');
                } else if (stepNum === stepNumber) {
                    step.classList.add('active');
                }
            });

            // Update hidden fields when changing steps
            updateHiddenFields();
            
            currentStep = stepNumber;
        }        // Function to check if a select element has a valid selection
        function hasValidSelection(selectElement) {
            return selectElement.selectedIndex > 0;  // First option is the placeholder
        }

        // Validate step inputs
        function validateStep(stepNumber) {
            if (stepNumber === 1) {
                const hasAnnee = hasValidSelection(anneeSelect);
                const hasNiveau = hasValidSelection(niveauSelect);
                console.log('Step 1 validation:', { annee: hasAnnee, niveau: hasNiveau });
                return hasAnnee && hasNiveau;
            } else if (stepNumber === 2) {
                const hasFiliere = hasValidSelection(filiereSelect);
                const hasSemestre = hasValidSelection(semestreSelect);
                console.log('Step 2 validation:', { filiere: hasFiliere, semestre: hasSemestre });
                return hasFiliere && hasSemestre;
            }
            return true; // Step 3 has optional fields
        }        // Next button event listeners
        nextButtons.forEach(button => {
            button.addEventListener('click', function () {
                const nextStep = parseInt(this.dataset.next);
                console.log('Attempting to move to step:', nextStep);
                
                if (validateStep(currentStep)) {
                    console.log('Step validation passed');
                    updateStep(nextStep);
                    
                    // Update progress steps to show completion of previous step
                    progressSteps[currentStep - 1].classList.add('completed');
                    
                    if (nextStep === 3) {
                        console.log('Preparing step 3...');
                        // When moving to step 3, check if we can generate subjects
                        const canGenerate = hasValidSelection(filiereSelect) && 
                                         hasValidSelection(semestreSelect) && 
                                         hasValidSelection(niveauSelect);
                        generateButton.disabled = !canGenerate;
                        
                        if (canGenerate) {
                            console.log('Auto-generating subjects...');
                            generateButton.click();
                        }
                    }
                } else {
                    console.log('Step validation failed');
                    const missingFields = [];
                    if (currentStep === 1) {
                        if (!hasValidSelection(anneeSelect)) missingFields.push('Academic Year');
                        if (!hasValidSelection(niveauSelect)) missingFields.push('Level');
                    } else if (currentStep === 2) {
                        if (!hasValidSelection(filiereSelect)) missingFields.push('Field of Study');
                        if (!hasValidSelection(semestreSelect)) missingFields.push('Semester');
                    }
                    alert(`Please complete the following fields: ${missingFields.join(', ')}`);
                }
            });
        });

        // Previous button event listeners
        prevButtons.forEach(button => {
            button.addEventListener('click', function () {
                const prevStep = parseInt(this.dataset.prev);
                updateStep(prevStep);
            });
        });

        // Update matiere options
        function updateMatiereOptions() {
            const filiereValue = filiereSelect.value;
            const semestreValue = semestreSelect.value;
            const niveauValue = niveauSelect.value;
            
            // Clear previous state
            matiereSelect.innerHTML = '<option value="">Select Subject</option>';
            matiereSelect.disabled = true;
            const existingAlert = form.querySelector('.alert-matiere');
            if (existingAlert) {
                existingAlert.remove();
            }

            if (filiereValue && semestreValue && niveauValue) {
                // Create key exactly as it appears in the data
                const key = `${filiereValue}_${semestreValue}_${niveauValue}`;
                console.log('Searching for subjects with key:', key);
                console.log('Available keys:', Object.keys(matiereData));
                
                const matieres = matiereData[key];
                console.log('Found matiere data:', matieres);

                if (matieres && matieres.length > 0) {
                    matieres.forEach(matiere => {
                        const opt = document.createElement('option');
                        opt.value = String(matiere.id);  // Ensure ID is a string
                        opt.textContent = matiere.nom;
                        matiereSelect.appendChild(opt);
                    });
                    matiereSelect.disabled = false;
                } else {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning alert-matiere mt-2';
                    alert.textContent = 'No subjects available for this combination.';
                    matiereSelect.parentElement.appendChild(alert);
                }
            }
        }

        // Update matiere commune options
        function updateMatiereCommuneOptions() {
            const filiereValue = filiereSelect.value;
            const semestreValue = semestreSelect.value;
            const niveauValue = niveauSelect.value;
            
            // Clear previous state
            matiereCommuneSelect.innerHTML = '<option value="">Select Common Subject</option>';
            matiereCommuneSelect.disabled = true;
            const existingAlert = form.querySelector('.alert-matiere-commune');
            if (existingAlert) {
                existingAlert.remove();
            }

            if (semestreValue && niveauValue) {
                const commonKey = `None_${semestreValue}_${niveauValue}`;
                const specificKey = `${filiereValue}_${semestreValue}_${niveauValue}`;
                
                console.log('Searching for common subjects:', {
                    commonKey,
                    specificKey,
                    available: Object.keys(matiereCommuneData)
                });

                // Get both common and filiere-specific subjects
                const commonMatieres = matiereCommuneData[commonKey] || [];
                const specificMatieres = matiereCommuneData[specificKey] || [];
                const allMatieres = [...commonMatieres, ...specificMatieres];

                console.log('Found common subjects:', {
                    common: commonMatieres.length,
                    specific: specificMatieres.length,
                    total: allMatieres.length
                });

                if (allMatieres.length > 0) {
                    allMatieres.forEach(matiere => {
                        const opt = document.createElement('option');
                        opt.value = String(matiere.id);  // Ensure ID is a string
                        opt.textContent = matiere.nom;
                        matiereCommuneSelect.appendChild(opt);
                    });
                    matiereCommuneSelect.disabled = false;
                } else {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning alert-matiere-commune mt-2';
                    alert.textContent = 'No common subjects available for this combination.';
                    matiereCommuneSelect.parentElement.appendChild(alert);
                }
            }
        }

        // Add debug logging to selection change handlers
        function logSelectionChange(element, value) {
            console.log(`${element.id} changed to:`, value);
            console.log('Current state:', {
                filiere: filiereSelect.value,
                semestre: semestreSelect.value,
                niveau: niveauSelect.value,
            });
        }        // Update event listeners
        filiereSelect.addEventListener('change', function() {
            logSelectionChange(this, this.value);
            checkGenerateButton();
            updateHiddenFields();
        });

        semestreSelect.addEventListener('change', function() {
            logSelectionChange(this, this.value);
            checkGenerateButton();
            updateHiddenFields();
        });

        niveauSelect.addEventListener('change', function() {
            logSelectionChange(this, this.value);
            checkGenerateButton();
            updateHiddenFields();
        });

        anneeSelect.addEventListener('change', function() {
            logSelectionChange(this, this.value);
            updateHiddenFields();
        });

        matiereSelect.addEventListener('change', function() {
            updateHiddenFields();
        });

        matiereCommuneSelect.addEventListener('change', function() {
            updateHiddenFields();
        });

        // Generate button handler
        generateButton.addEventListener('click', function() {
            console.log('Generate button clicked');
            
            // Get current values
            const filiereValue = filiereSelect.value;
            const semestreValue = semestreSelect.value;
            const niveauValue = niveauSelect.value;
            
            console.log('Current selection:', {
                filiere: filiereValue,
                semestre: semestreValue,
                niveau: niveauValue
            });

            // Clear any existing alerts
            document.querySelectorAll('.alert-matiere, .alert-matiere-commune').forEach(alert => alert.remove());
            
            // Update subjects
            updateMatiereOptions();
            updateMatiereCommuneOptions();
            
            // Show success in UI
            if (!matiereSelect.disabled || !matiereCommuneSelect.disabled) {
                progressSteps[2].classList.add('active');
            }
        });

        // Initial setup
        checkGenerateButton();
    });
</script>

{% if form.errors %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var myModal = new bootstrap.Modal(document.getElementById('createProfileModal'));
        myModal.show();
    });
</script>
{% endif %}

<!-- Lottie Player Library -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<!-- Bootstrap JS (ensure dropdown functionality) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}